{% assign translations = settings.password_page %}


<!doctype html>
<html class="bg-[#fbfcf1] overflow-x-hidden">
  <head>
    <title>{{ page_title }}</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content="{{ page_description | escape }}">
    <link rel="canonical" href="{{ canonical_url }}">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    {{ content_for_header }}
    <!-- Header hook for plugins -->
    {{ 'application.css' | asset_url | stylesheet_tag }}
    {{ 'application.js' | asset_url | script_tag }}
    <script src="{{ 'cart-updates.js' | asset_url }}"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    [x-cloak] { display: none !important;}
  </style>
  {% include 'pagefly-app-header' %}
  <link rel="icon" href="{{ 'gilli_logo.png' | asset_url }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ 'gilli_logo.png' | asset_url }}" type="image/x-icon">
  <meta name="google-site-verification" content="FG-h1egwaqiX8wlKVfjU_So4jq0lzUXcMjPfPj6WGpw" />
  </head>
  <body class="overflow-x-hidden sm:overflow-x-auto">
    <header id="top"></header>
    {% section 'header' %}
    <main role="main">
      {{ content_for_layout }}
    </main>
    {% section 'footer' %}
    
      {% if customer == null %}
    <div id="signup-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/70 px-4" role="dialog" aria-modal="true" aria-labelledby="signup-modal-title" aria-describedby="signup-modal-copy" style="display: none !important;">
      <div class="relative w-full max-w-lg rounded-2xl border border-gray-200 bg-white px-8 py-10 text-center shadow-2xl">
        <button type="button" id="signup-modal-close" class="absolute right-4 top-4 text-gray-400 transition hover:text-gray-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500" aria-label="Close signup offer">
          <span aria-hidden="true">&times;</span>
          </button>
        <p class="mb-3 text-sm font-semibold uppercase tracking-[0.3em] text-gray-500">Welcome Offer</p>
        <h3 id="signup-modal-title" class="mb-2 text-3xl font-bold text-gray-900">Join the GGS Family</h3>
        <p class="mb-6 text-lg text-gray-600" id="signup-modal-copy">Create a free account today and unlock 20% off your first order plus early access to new products.</p>
        {% form 'contact', id: 'signup-modal-form', class: 'flex flex-col gap-3' %}
          <input type="hidden" name="contact[tags]" value="Signup Modal">
          <input type="hidden" name="contact[accepts_marketing]" value="true">
          {% if form.posted_successfully? %}
            <p class="rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm font-medium text-green-700">Thanks! Please check your inbox to complete your signup.</p>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
                try {
                  localStorage.setItem('signupModalDismissed', 'true');
                } catch (error) {
                  console.debug('Signup modal storage unavailable', error);
        }
              });
      </script>
          {% else %}
            <div class="flex flex-col gap-3 sm:flex-row">
              <input type="email" name="contact[email]" id="signup-modal-email" placeholder="Enter your email" required class="w-full rounded-xl border border-gray-300 px-5 py-3 text-base text-gray-900 placeholder:text-gray-400 focus:border-red-400 focus:outline-none focus:ring-2 focus:ring-red-200" aria-label="Email address">
              <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-xl bg-[#bd2d2d] px-6 py-3 text-base font-semibold uppercase tracking-wide text-white shadow-lg transition hover:bg-red-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500">Get 20% off</button>
            </div>
            {% if form.errors %}
              <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-600">{{ form.errors | default_errors }}</div>
            {% endif %}
      {% endif %}
        {% endform %}
        <button type="button" id="signup-modal-remind" class="text-sm font-medium text-gray-500 underline underline-offset-4 transition hover:text-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300">Maybe later</button>
      </div>
    </div>
    <script>
      (function () {
        const modalId = 'signup-modal';
        const storageKey = 'signupModalDismissed';
        const delayMs = 1500;

        let storageAvailable = null;

        function canUseStorage() {
          if (storageAvailable !== null) return storageAvailable;
          try {
            const testKey = '__signupModalTest__';
            localStorage.setItem(testKey, testKey);
            localStorage.removeItem(testKey);
            storageAvailable = true;
            return storageAvailable;
          } catch (error) {
            storageAvailable = false;
            return storageAvailable;
          }
        }

        function hasDismissed() {
          if (!canUseStorage()) return false;
          return localStorage.getItem(storageKey) === 'true';
        }

        function setDismissed() {
          if (!canUseStorage()) return;
          localStorage.setItem(storageKey, 'true');
        }

        function showModal() {
          const modal = document.getElementById(modalId);
          if (!modal) return;
          // Check again before showing (in case dismissed during delay)
          if (hasDismissed()) {
            return;
          }
          modal.style.display = '';
          modal.classList.remove('hidden');
          // Use flex for desktop, block for mobile
          if (window.innerWidth >= 640) {
            modal.style.display = 'flex';
          } else {
            modal.style.display = 'block';
          }
        }

        function hideModal(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          const modal = document.getElementById(modalId);
          if (!modal) return;
          modal.classList.add('hidden');
          modal.style.display = 'none';
          setDismissed();
        }

        // Check dismissal state immediately and hide modal if already dismissed
        function initModal() {
          const modal = document.getElementById(modalId);
          if (modal && hasDismissed()) {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            return;
          }
        }

        // Run immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function () {
            initModal();
            const modal = document.getElementById(modalId);
            const closeButton = document.getElementById('signup-modal-close');
            const remindButton = document.getElementById('signup-modal-remind');

            // Always set up event listeners
            if (closeButton) {
              closeButton.addEventListener('click', hideModal);
            }

            if (remindButton) {
              remindButton.addEventListener('click', hideModal);
            }

            if (modal) {
              modal.addEventListener('click', function (event) {
                if (event.target === modal) {
                  hideModal(event);
                }
              });
            }

            // Only show modal if it hasn't been dismissed
            if (!hasDismissed()) {
              setTimeout(showModal, delayMs);
            }
          });
        } else {
          initModal();
          const modal = document.getElementById(modalId);
          const closeButton = document.getElementById('signup-modal-close');
          const remindButton = document.getElementById('signup-modal-remind');

          if (closeButton) {
            closeButton.addEventListener('click', hideModal);
          }

          if (remindButton) {
            remindButton.addEventListener('click', hideModal);
          }

          if (modal) {
            modal.addEventListener('click', function (event) {
              if (event.target === modal) {
                hideModal(event);
              }
            });
          }

          if (!hasDismissed()) {
            setTimeout(showModal, delayMs);
          }
        }
      })();
    </script>
    {% endif %}

    <script>
      (function () {
        if (window.__ggsCartSubmitHandlerInitialized) {
          console.debug('[GGS Cart] Global submit handler already initialised.');
          return;
        }
        window.__ggsCartSubmitHandlerInitialized = true;
        console.debug('[GGS Cart] Initialising global submit handler.');

        document.addEventListener('submit', function (event) {
          const form = event.target.closest('form[action="/cart/add"]');
          if (!form) {
            return;
          }

          event.preventDefault();
          try {
            if (typeof event.stopImmediatePropagation === 'function') {
              event.stopImmediatePropagation();
            }
            if (typeof event.stopPropagation === 'function') {
              event.stopPropagation();
            }
          } catch (propagationError) {
            console.debug('[GGS Cart] Unable to stop propagation', propagationError);
          }

          if (form.dataset.ggsProcessing === 'true') {
            console.debug('[GGS Cart] Skipping because form is already processing.');
            return;
          }
          form.dataset.ggsProcessing = 'true';

          console.debug('[GGS Cart] Intercepted submit from form:', form, {
            isTrusted: event.isTrusted,
          });

          // console.trace('[GGS Cart] Trace for intercepted submit');

          const formData = new FormData(form);
          const variantId = formData.get('id');
          const quantity = formData.get('quantity') || 1;
          console.debug('[GGS Cart] Preparing add-to-cart fetch', {
            variantId: variantId,
            quantity: quantity,
          });

          const submitButton = form.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerText = 'Adding...';
          }

          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({
              id: variantId,
              quantity: quantity,
            }),
          })
            .then(function (response) {
              console.debug('[GGS Cart] Fetch response status:', response.status);
              return response.json();
            })
            .then(function (data) {
              console.debug('[GGS Cart] Item added to cart:', data);
              try {
                document.dispatchEvent(
                  new CustomEvent('ggs:cart-item-added', { detail: data })
                );
              } catch (dispatchError) {
                console.debug('[GGS Cart] Unable to dispatch cart event', dispatchError);
              }
            })
            .catch(function (error) {
              console.error('[GGS Cart] Error adding item to cart:', error);
            })
            .finally(function () {
              delete form.dataset.ggsProcessing;
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerText = 'Add to cart';
              }
            });
        });
      })();
    </script>

    {% comment %} Restore page if accidentally hidden {% endcomment %}
    <script>
      (function() {
        // Check if main content is hidden and restore it
        const main = document.querySelector('main');
        const body = document.body;
        let needsRestore = false;
        
        if (main) {
          const mainStyle = window.getComputedStyle(main);
          if (mainStyle.display === 'none' || mainStyle.visibility === 'hidden') {
            main.style.display = '';
            main.style.visibility = '';
            main.style.opacity = '';
            main.style.height = '';
            main.style.overflow = '';
            main.classList.remove('hidden');
            needsRestore = true;
          }
        }
        if (body) {
          const bodyStyle = window.getComputedStyle(body);
          if (bodyStyle.display === 'none' || bodyStyle.visibility === 'hidden') {
            body.style.display = '';
            body.style.visibility = '';
            body.style.opacity = '';
            body.classList.remove('hidden');
            needsRestore = true;
          }
        }
        
        // If we had to restore content, clear the cookie banner dismissal
        // so it can show again (but won't hide the page)
        if (needsRestore) {
          try {
            localStorage.removeItem('cookiePrivacyBannerDismissed');
            console.log('[Page Restore] Cleared cookie banner dismissal state');
          } catch (e) {
            // Storage unavailable
          }
        }
      })();
    </script>

    {% comment %} Cookie/Privacy Banner Dismissal Handler {% endcomment %}
    <script>
      (function () {
        const cookieBannerStorageKey = 'cookiePrivacyBannerDismissed';
        
        function canUseStorage() {
          try {
            const testKey = '__cookieBannerTest__';
            localStorage.setItem(testKey, testKey);
            localStorage.removeItem(testKey);
            return true;
          } catch (error) {
            return false;
          }
        }

        function hasDismissed() {
          if (!canUseStorage()) return false;
          return localStorage.getItem(cookieBannerStorageKey) === 'true';
        }

        function setDismissed() {
          if (!canUseStorage()) return;
          localStorage.setItem(cookieBannerStorageKey, 'true');
        }

        function isModalOverlay(element) {
          if (!element) return false;
          
          // Exclude main content areas
          const tagName = element.tagName.toLowerCase();
          if (['body', 'html', 'main', 'header', 'footer', 'nav'].includes(tagName)) {
            return false;
          }
          
          // Must be a dialog/alertdialog or have modal-like positioning
          const hasDialogRole = element.getAttribute('role') === 'dialog' || 
                               element.getAttribute('role') === 'alertdialog';
          
          const style = window.getComputedStyle(element);
          const isFixed = style.position === 'fixed';
          const isAbsolute = style.position === 'absolute';
          const zIndex = parseInt(style.zIndex) || 0;
          
          // Must be positioned as overlay (fixed/absolute) with high z-index, OR have dialog role
          return hasDialogRole || (isFixed && zIndex >= 50) || (isAbsolute && zIndex >= 50);
        }

        function hideBanner(banner) {
          if (!banner) return;
          // Only hide if it's actually a modal overlay
          if (!isModalOverlay(banner)) return;
          
          banner.style.display = 'none';
          banner.style.visibility = 'hidden';
          banner.style.opacity = '0';
          banner.classList.add('hidden');
          banner.setAttribute('aria-hidden', 'true');
          setDismissed();
        }

        function findAndHandleBanner() {
          if (!hasDismissed()) return;

          // Only target actual modal/dialog elements
          const modalSelectors = [
            '[role="dialog"]',
            '[role="alertdialog"]'
          ];

          for (const selector of modalSelectors) {
            try {
              const elements = document.querySelectorAll(selector);
              for (const el of elements) {
                // Only hide if it's a modal overlay AND contains cookie/privacy text
                if (!isModalOverlay(el)) continue;
                
                const text = (el.textContent || '').toLowerCase();
                if (text.includes('cookie') || 
                    text.includes('privacy') || 
                    text.includes('consent') || 
                    text.includes('value your privacy')) {
                  const style = window.getComputedStyle(el);
                  if (style.display !== 'none' && style.visibility !== 'hidden' && style.opacity !== '0') {
                    hideBanner(el);
                  }
                }
              }
            } catch (e) {
              // Invalid selector, continue
            }
          }
        }

        function setupBannerButtons() {
          if (hasDismissed()) return;

          // Only look for buttons within modal/dialog elements
          const modals = document.querySelectorAll('[role="dialog"], [role="alertdialog"]');
          
          modals.forEach(function(modal) {
            if (!isModalOverlay(modal)) return;
            
            const text = (modal.textContent || '').toLowerCase();
            // Only set up handlers for cookie/privacy modals
            if (!text.includes('cookie') && !text.includes('privacy') && !text.includes('consent')) {
              return;
            }
            
            const buttons = modal.querySelectorAll('button, a, [role="button"], [onclick]');
            buttons.forEach(function(btn) {
              const btnText = (btn.textContent || '').toLowerCase().trim();
              if (btnText.includes('accept') || 
                  btnText.includes('agree') || 
                  btnText.includes('close') || 
                  btnText.includes('dismiss') || 
                  btnText.includes('ok') ||
                  btnText.includes('decline') ||
                  btnText.includes('got it')) {
                
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  hideBanner(modal);
                  return false;
                }, true);
              }
            });
          });
        }

        function initCookieBanner() {
          // If already dismissed, hide any visible banners
          if (hasDismissed()) {
            findAndHandleBanner();
            // Keep checking periodically for dynamically added banners
            setInterval(findAndHandleBanner, 500);
          } else {
            // Set up button handlers
            setupBannerButtons();
            // Check periodically for new banners
            let attempts = 0;
            const checkInterval = setInterval(function() {
              attempts++;
              setupBannerButtons();
              if (attempts >= 40) { // Stop after 20 seconds
                clearInterval(checkInterval);
              }
            }, 500);
          }
        }

        // Use MutationObserver to catch dynamically added banners
        const observer = new MutationObserver(function(mutations) {
          if (hasDismissed()) {
            findAndHandleBanner();
          } else {
            setupBannerButtons();
          }
        });

        // Initialize
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            initCookieBanner();
            observer.observe(document.body, {
              childList: true,
              subtree: true,
              attributes: true,
              attributeFilter: ['style', 'class']
            });
          });
        } else {
          initCookieBanner();
          observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
          });
        }
      })();
    </script>

  </body>

</html>